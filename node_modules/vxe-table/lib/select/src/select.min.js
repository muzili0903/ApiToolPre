"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderOption=renderOption,exports.renderOptgroup=renderOptgroup,exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_input=_interopRequireDefault(require("../../input/src/input")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=_interopRequireDefault(require("../../mixins/size")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function isOptionVisible(t){return!1!==t.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}function getOptkey(t){return t.optionId||"_XID"}function getOptid(t,e){t=e[getOptkey(t)];return t?encodeURIComponent(t):""}function findOffsetOption(t,e,i){var n,o,s,l,r=t.isGroup,a=t.visibleOptionList,u=t.visibleGroupList,p=t.valueField,f=t.groupOptionsField;if(r)for(var c=0;c<u.length;c++){var h=u[c],d=h[f],v=h.disabled;if(d)for(var b=0;b<d.length;b++){var O=d[b],g=isOptionVisible(O),m=v||O.disabled;if(n||m||(n=O),l&&g&&!m&&(s=O,!i))return{offsetOption:s};if(e===O[p]){if(l=O,i)return{offsetOption:o}}else g&&!m&&(o=O)}}else for(var x=0;x<a.length;x++){var P=a[x],_=P.disabled;if(n||_||(n=P),l&&!_&&(s=P,!i))return{offsetOption:s};if(e===P[p]){if(l=P,i)return{offsetOption:o}}else _||(o=P)}return{firstOption:n}}function findOption(t,e){var i=t.isGroup,n=t.fullOptionList,o=t.fullGroupList,s=t.valueField;if(i)for(var l=0;l<o.length;l++){var r=o[l];if(r.options)for(var a=0;a<r.options.length;a++){var u=r.options[a];if(e===u[s])return u}}return n.find(function(t){return e===t[s]})}function getSelectLabel(t,e){var i=findOption(t,e);return _xeUtils.default.toValueString(i?i[t.labelField]:e)}function renderOption(l,r,t,a){var u=r.isGroup,p=r.labelField,f=r.valueField,c=r.optionKey,h=r.value,d=r.multiple,v=r.currentValue;return t.map(function(t,e){var i=!u||isOptionVisible(t),n=a&&a.disabled||t.disabled,o=t[f],s=getOptid(r,t);return i?l("div",{key:c?s:e,class:["vxe-select-option",t.className,{"is--disabled":n,"is--selected":d?h&&-1<h.indexOf(o):h===o,"is--hover":v===o}],attrs:{optid:s},on:{mousedown:r.mousedownOptionEvent,click:function(t){n||r.changeOptionEvent(t,o)},mouseenter:function(){n||r.setCurrentOption(t)}}},_tools.UtilTools.formatText(_tools.UtilTools.getFuncText(t[p]))):null})}function renderOptgroup(o,s){var l=s.optionKey,t=s.visibleGroupList,r=s.groupLabelField,a=s.groupOptionsField;return t.map(function(t,e){var i=getOptid(s,t),n=t.disabled;return o("div",{key:l?i:e,class:["vxe-optgroup",t.className,{"is--disabled":n}],attrs:{optid:i}},[o("div",{class:"vxe-optgroup--title"},_tools.UtilTools.getFuncText(t[r])),o("div",{class:"vxe-optgroup--wrapper"},renderOption(o,s,t[a],t))])})}function renderOpts(t,e){var i=e.isGroup,n=e.visibleGroupList,o=e.visibleOptionList;if(i){if(n.length)return renderOptgroup(t,e)}else if(o.length)return renderOption(t,e,o);return[t("div",{class:"vxe-select--empty-placeholder"},e.emptyText||_conf.default.i18n("vxe.select.emptyText"))]}var _default2={name:"VxeSelect",mixins:[_size.default],props:{value:null,clearable:Boolean,placeholder:String,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:function(){return _conf.default.select.multiCharOverflow}},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,className:[String,Function],size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},emptyText:String,optionId:{type:String,default:function(){return _conf.default.select.optionId}},optionKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},components:{VxeInput:_input.default},provide:function(){return{$xeselect:this}},data:function(){return{inited:!1,collectOption:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],panelIndex:0,panelStyle:null,panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}},computed:{propsOpts:function(){return this.optionProps||{}},groupPropsOpts:function(){return this.optionGroupProps||{}},labelField:function(){return this.propsOpts.label||"label"},valueField:function(){return this.propsOpts.value||"value"},groupLabelField:function(){return this.groupPropsOpts.label||"label"},groupOptionsField:function(){return this.groupPropsOpts.options||"options"},isGroup:function(){return this.fullGroupList.some(function(t){return t.options&&t.options.length})},multiMaxCharNum:function(){return _xeUtils.default.toNumber(this.multiCharOverflow)},selectLabel:function(){var e=this,t=this.value,i=this.multiple,n=this.multiMaxCharNum;return t&&i?t.map(function(t){t=getSelectLabel(e,t);return 0<n&&t.length>n?"".concat(t.substring(0,n),"..."):t}).join(", "):getSelectLabel(this,t)}},watch:{collectOption:function(t){t.some(function(t){return t.options&&t.options.length})?(this.fullOptionList=[],this.fullGroupList=t):(this.fullGroupList=[],this.fullOptionList=t),this.updateCache()},options:function(t){this.fullGroupList=[],this.fullOptionList=t,this.updateCache()},optionGroups:function(t){this.fullOptionList=[],this.fullGroupList=t,this.updateCache()}},created:function(){var t=this.options,e=this.optionGroups;e?this.fullGroupList=e:t&&(this.fullOptionList=t),this.updateCache(),_tools.GlobalEvent.on(this,"mousewheel",this.handleGlobalMousewheelEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},beforeDestroy:function(){var t=this.$refs.panel;t&&t.parentNode&&t.parentNode.removeChild(t)},destroyed:function(){_tools.GlobalEvent.off(this,"mousewheel"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"blur")},render:function(t){var e=this.vSize,i=this.className,n=this.inited,o=this.isActivated,s=this.disabled,l=this.visiblePanel;return t("div",{class:["vxe-select",i?_xeUtils.default.isFunction(i)?i({$select:this}):i:"",(_defineProperty(i={},"size--".concat(e),e),_defineProperty(i,"is--visivle",l),_defineProperty(i,"is--disabled",s),_defineProperty(i,"is--active",o),i)]},[t("div",{class:"vxe-select-slots",ref:"hideOption"},this.$slots.default),t("vxe-input",{ref:"input",props:{clearable:this.clearable,placeholder:this.placeholder,readonly:!0,disabled:s,type:"text",prefixIcon:this.prefixIcon,suffixIcon:l?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,value:this.selectLabel},on:{clear:this.clearEvent,click:this.togglePanelEvent,focus:this.focusEvent,blur:this.blurEvent,"suffix-click":this.togglePanelEvent}}),t("div",{ref:"panel",class:["vxe-table--ignore-clear vxe-select--panel",(_defineProperty(s={},"size--".concat(e),e),_defineProperty(s,"is--transfer",this.transfer),_defineProperty(s,"animat--leave",this.animatVisible),_defineProperty(s,"animat--enter",l),s)],attrs:{placement:this.panelPlacement},style:this.panelStyle},n?[t("div",{ref:"optWrapper",class:"vxe-select-option--wrapper"},renderOpts(t,this))]:null)])},methods:{updateCache:function(){function e(t){getOptid(i,t)||(t[s]=getOptUniqueId())}var i=this,t=this.fullOptionList,n=this.fullGroupList,o=this.groupOptionsField,s=getOptkey(this);n.length?n.forEach(function(t){e(t),t[o]&&t[o].forEach(e)}):t.length&&t.forEach(e),this.refreshOption()},refreshOption:function(){var t=this.isGroup,e=this.fullOptionList,i=this.fullGroupList;return t?this.visibleGroupList=i.filter(isOptionVisible):this.visibleOptionList=e.filter(isOptionVisible),this.$nextTick()},setCurrentOption:function(t){t&&(this.currentValue=t[this.valueField])},scrollToOption:function(n,o){var s=this;return this.$nextTick().then(function(){var t,e,i;n&&(t=(i=s.$refs).optWrapper,e=i.panel.querySelector("[optid='".concat(getOptid(s,n),"']")),t&&e&&(i=t.offsetHeight,o?e.offsetTop+e.offsetHeight-t.scrollTop>i&&(t.scrollTop=e.offsetTop+e.offsetHeight-i):(e.offsetTop+5<t.scrollTop||e.offsetTop+5>t.scrollTop+t.clientHeight)&&(t.scrollTop=e.offsetTop-5)))})},clearEvent:function(t,e){this.clearValueEvent(e,null),this.hideOptionPanel()},clearValueEvent:function(t,e){this.changeEvent(t,e),this.$emit("clear",{value:e,$event:t})},changeEvent:function(t,e){e!==this.value&&(this.$emit("input",e),this.$emit("change",{value:e,$event:t}))},mousedownOptionEvent:function(t){0===t.button&&t.stopPropagation()},changeOptionEvent:function(t,e){var i=this.value;this.multiple?(i=i?-1===i.indexOf(e)?i.concat([e]):i.filter(function(t){return t!==e}):[e],this.changeEvent(t,i)):(this.changeEvent(t,e),this.hideOptionPanel())},handleGlobalMousewheelEvent:function(t){var e=this.$refs,i=this.disabled,n=this.visiblePanel;i||n&&(_tools.DomTools.getEventTargetNode(t,e.panel).flag?this.updatePlacement():this.hideOptionPanel())},handleGlobalMousedownEvent:function(t){var e=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;n||(this.isActivated=_tools.DomTools.getEventTargetNode(t,i).flag||_tools.DomTools.getEventTargetNode(t,e.panel).flag,o&&!this.isActivated&&this.hideOptionPanel())},handleGlobalKeydownEvent:function(t){var e,i,n,o,s,l,r,a=this.visiblePanel,u=this.currentValue,p=this.clearable;this.disabled||(e=13===(l=t.keyCode),r=27===l,i=38===l,n=40===l,o=46===l,s=32===l,(l=9===l)&&(this.isActivated=!1),a?r||l?this.hideOptionPanel():e?(t.preventDefault(),t.stopPropagation(),this.changeOptionEvent(t,u)):i||n?(t.preventDefault(),l=(r=findOffsetOption(this,u,i)).firstOption,(r=r.offsetOption)||findOption(this,u)||(r=l),this.setCurrentOption(r),this.scrollToOption(r,n)):s&&t.preventDefault():(i||n||e||s)&&this.isActivated&&(t.preventDefault(),this.showOptionPanel()),this.isActivated&&o&&p&&this.clearValueEvent(t,null))},handleGlobalBlurEvent:function(){this.hideOptionPanel()},updateZindex:function(){this.panelIndex<_tools.UtilTools.getLastZIndex()&&(this.panelIndex=_tools.UtilTools.nextZIndex())},focusEvent:function(){this.disabled||(this.isActivated=!0)},blurEvent:function(){this.isActivated=!1},isPanelVisible:function(){return this.visiblePanel},togglePanel:function(){this.visiblePanel?this.hideOptionPanel():this.showOptionPanel(),this.$nextTick()},hidePanel:function(){this.visiblePanel&&this.hideOptionPanel(),this.$nextTick()},showPanel:function(){this.visiblePanel||this.showOptionPanel(),this.$nextTick()},togglePanelEvent:function(t){t.$event.preventDefault(),this.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},showOptionPanel:function(){var i=this;this.disabled||(clearTimeout(this.hidePanelTimeout),this.inited||(this.inited=!0,this.transfer&&document.body.appendChild(this.$refs.panel)),this.isActivated=!0,this.animatVisible=!0,setTimeout(function(){var t=i.value,e=i.multiple,t=findOption(i,e&&t?t[0]:t);i.visiblePanel=!0,t&&(i.setCurrentOption(t),i.scrollToOption(t))},10),this.updateZindex(),this.updatePlacement())},hideOptionPanel:function(){var t=this;this.visiblePanel=!1,this.hidePanelTimeout=setTimeout(function(){t.animatVisible=!1},350)},updatePlacement:function(){var c=this;return this.$nextTick().then(function(){var t=c.$refs,e=c.transfer,i=c.placement,n=c.panelIndex,o=t.input.$el,s=t.panel;if(s&&o){var l=o.offsetHeight,r=o.offsetWidth,a=s.offsetHeight,u=s.offsetWidth,p={zIndex:n},f=_tools.DomTools.getAbsolutePos(o),t=f.boundingTop,s=f.boundingLeft,n=f.visibleHeight,o=f.visibleWidth,f="bottom";return e?(e=t+l,"top"===i?(f="top",e=t-a):i||(n<e+a+5&&(f="top",e=t-a),e<5&&(f="bottom",e=t+l)),o<(s=s)+u+5&&(s-=s+u+5-o),s<5&&(s=5),Object.assign(p,{left:"".concat(s,"px"),top:"".concat(e,"px"),minWidth:"".concat(r,"px")})):"top"===i?(f="top",p.bottom="".concat(l,"px")):i||n<t+l+a&&5<t-l-a&&(f="top",p.bottom="".concat(l,"px")),c.panelStyle=p,c.panelPlacement=f,c.$nextTick()}})},focus:function(){return this.isActivated=!0,this.$refs.input.focus(),this.$nextTick()},blur:function(){return this.hideOptionPanel(),this.$refs.input.blur(),this.$nextTick()}}};exports.default=_default2;