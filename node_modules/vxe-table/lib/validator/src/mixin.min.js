"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}(),_default={methods:{_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(t){var r=this;return new Promise(function(e){!1===r.validOpts.autoPos?(r.emitEvent("valid-error",t),e()):r.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(r.showValidTooltip(t))},10)})})},beginValidate:function(e,s,i){var o=this,u={},l=this.editRules,c=this.afterFullData,d=this.treeConfig,t=this.treeOpts;!0===e?r=c:e&&(_xeUtils.default.isFunction(e)?s=e:r=_xeUtils.default.isArray(e)?e:[e]);var r=r||this.getInsertRecords().concat(this.getUpdateRecords()),n=[];if(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),l){var a=this.getColumns(),e=function(r){var e;!i&&o.validRuleErr||(e=[],a.forEach(function(t){!i&&o.validRuleErr||!_xeUtils.default.has(l,t.property)||e.push(o.validCellRules("all",r,t).catch(function(e){e={rule:e.rule,rules:e.rules,rowIndex:o.getRowIndex(r),row:r,columnIndex:o.getColumnIndex(t),column:t,$table:o};if(u[t.property]||(u[t.property]=[]),u[t.property].push(e),!i)return o.validRuleErr=!0,Promise.reject(e)}))}),n.push(Promise.all(e)))};return d?_xeUtils.default.eachTree(r,e,t):r.forEach(e),Promise.all(n).then(function(){var e=Object.keys(u);return o.$nextTick().then(function(){return e.length?Promise.reject(u[e[0]][0]):void(s&&s())})}).catch(function(a){return new Promise(function(e,t){function r(){o.$nextTick(function(){s?(s(u),e()):t(u)})}function i(){a.cell=o.getCell(a.row,a.column),_tools.DomTools.scrollToView(a.cell),o.handleValidError(a).then(r)}var l=a.row,n=c.indexOf(l),l=0<n?c[n-1]:l;!1===o.validOpts.autoPos?r():(d?o.scrollToTreeRow(l):o.scrollToRow(l)).then(i)})})}return this.$nextTick().then(function(){s&&s()})},hasCellRules:function(t,e,r){var i=this.editRules,r=r.property;if(r&&i){r=_xeUtils.default.get(i,r);return r&&_xeUtils.default.find(r,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(l,n,a,e){var s,o,u=this,t=this.editRules,r=a.property,c=[],d=[];return r&&t&&((s=_xeUtils.default.get(t,r))&&(o=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(n,r):e,s.forEach(function(t){var e,r,i;"all"!==l&&t.trigger&&l!==t.trigger||(_xeUtils.default.isFunction(t.validator)?(i=t.validator({cellValue:o,rule:t,rules:s,row:n,rowIndex:u.getRowIndex(n),column:a,columnIndex:u.getColumnIndex(a),$table:u}))&&(_xeUtils.default.isError(i)?(u.validRuleErr=!0,c.push(new Rule({type:"custom",trigger:t.trigger,message:i.message,rule:new Rule(t)}))):i.catch&&d.push(i.catch(function(e){u.validRuleErr=!0,c.push(new Rule({type:"custom",trigger:t.trigger,message:(e&&e.message?e:t).message,rule:new Rule(t)}))}))):(e="number"===t.type,r="array"===t.type,i=e?_xeUtils.default.toNumber(o):_xeUtils.default.getSize(o),(t.required&&(r?!_xeUtils.default.isArray(o)||!o.length:null==o||""===o)||e&&isNaN(o)||!isNaN(t.min)&&i<parseFloat(t.min)||!isNaN(t.max)&&i>parseFloat(t.max)||t.pattern&&!(t.pattern.test?t.pattern:new RegExp(t.pattern)).test(o))&&(u.validRuleErr=!0,c.push(new Rule(t)))))}))),Promise.all(d).then(function(){if(c.length){var e={rules:c,rule:c[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(t){var r=this,e=this.editConfig,i=this.editStore,l=this.editRules,n=this.validStore,i=i.actived;if(i.row&&l){var i=i.args,a=i.row,s=i.column,o=i.cell;if(this.hasCellRules(t,a,s))return this.validCellRules(t,a,s).then(function(){"row"===e.mode&&n.visible&&n.row===a&&n.column===s&&r.clearValidate()}).catch(function(e){e=e.rule;if(e.trigger&&t!==e.trigger)return Promise.resolve();e={rule:e,row:a,column:s,cell:o};return r.showValidTooltip(e),Promise.reject(e)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,i=this.height,l=this.tableData,n=this.validOpts,a=e.rule,s=e.row,o=e.column,u=e.cell,c=r.validTip,d=a.message;return this.$nextTick(function(){if(Object.assign(t.validStore,{row:s,column:o,rule:a,content:d,visible:!0}),t.emitEvent("valid-error",e),c&&("tooltip"===n.message||"default"===n.message&&!i&&l.length<2))return c.open(u,d)})}}};exports.default=_default;